<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Toernooitje Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getFirestore, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCRTFu3fH7EwPpUzO23P8dLPZ-DLadoFFA",
      authDomain: "toernooitje.firebaseapp.com",
      projectId: "toernooitje",
      storageBucket: "toernooitje.firebasestorage.app",
      messagingSenderId: "491214474157",
      appId: "1:491214474157:web:3fe8a6df93a40695dc6f24",
      measurementId: "G-SF3G5J6NJ9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

// Lijst oude toernooien ophalen
async function laadOudeToernooien() {
  const select = document.createElement("select");
  select.id = "oudeToernooien";
  select.innerHTML = '<option value="">-- Kies eerder toernooi --</option>';

  const prefix = `scores_${team}`;
  const snapshot = await getDocs(collectionGroup(db, prefix));
  const keys = new Set();
  snapshot.forEach(doc => {
  const parts = doc.id.split("_");
  const key = parts[0];
  const datum = doc.data().datum || "onbekend";
  keys.add(`${key}|${datum}`);
});

  keys.forEach(k => {
  const [id, datum] = k.split('|');
  const opt = document.createElement("option");
  opt.value = id;
  opt.textContent = `Toernooi ${id} (${datum})`;
    select.appendChild(opt);
  });

  const container = document.getElementById("oudeToernooiSelectie");
  container.innerHTML = "<h3>Vorige toernooien</h3>";
  container.appendChild(select);
  select.addEventListener("change", async e => {
  const gekozenId = e.target.value;
  if (!gekozenId) return;

  schema = [];
  spelers = new Set();

  const prefix = `scores_${team}`;
  const snapshot = await getDocs(collection(db, prefix));

  snapshot.forEach(docSnap => {
    const id = docSnap.id;
    if (id.startsWith(gekozenId + "_")) {
      const data = docSnap.data();
      const [rondeStr, veldStr] = id.replace(`${gekozenId}_`, "").split("_v");
      const ronde = parseInt(rondeStr);
      const veld = parseInt(veldStr);

      const teamA = data.teamA || [];
      const teamB = data.teamB || [];
      const a = data.a;
      const b = data.b;

      teamA.forEach(sp => spelers.add(sp));
      teamB.forEach(sp => spelers.add(sp));

      if (!schema[ronde]) schema[ronde] = [];
      schema[ronde][veld] = { veld: veld + 1, teamA, teamB, score: { a, b } };
    }
  });

  spelers = Array.from(spelers);
  renderSchema();

  schema.forEach((ronde, r) => {
    ronde.forEach((wedstrijd, v) => {
      if (wedstrijd && wedstrijd.score) {
        const id = `r${r}_v${v}`;
        const aEl = document.getElementById(`${id}a`);
        const bEl = document.getElementById(`${id}b`);
        if (aEl) aEl.value = wedstrijd.score.a;
        if (bEl) bEl.value = wedstrijd.score.b;
      }
    });
  });

  updateStand();
});
}

    const appDiv = document.getElementById("app");
    const punten = {};
    let spelers = [];
    let schema = [];
    let veldInstellingen = [];
    let team = null;

    document.getElementById("teamSelectBtn").addEventListener("click", async () => {
  team = document.getElementById("teamKeuze").value;
  if (!team) return alert("Kies een team om door te gaan.");
  document.getElementById("teamSelect").style.display = "none";
  document.getElementById("configuratie").style.display = "block";
  await laadOudeToernooien();
  const wisselBtn = document.createElement("button");
  wisselBtn.textContent = `Team wijzigen (${team})`;
  wisselBtn.style.float = "right";
  wisselBtn.addEventListener("click", () => {   document.getElementById("configuratie").style.display = "none";   document.getElementById("teamSelect").style.display = "block";   document.getElementById("oudeToernooiSelectie").innerHTML = "";   team = null; });
  document.getElementById("configuratie").prepend(wisselBtn);
});

    document.getElementById("aantalVelden").addEventListener("change", () => {
      const n = parseInt(document.getElementById("aantalVelden").value);
      const veldDiv = document.getElementById("veldenInstellingen");
      veldDiv.innerHTML = "";
      for (let i = 0; i < n; i++) {
        veldDiv.innerHTML += `
          <label>Veld ${i + 1} (teamgrootte):
            <input type="number" id="veld_${i}" value="2" min="1" max="5">
          </label><br>`;
      }
    });

    document.getElementById("aantalSpelers").addEventListener("change", () => {
      const n = parseInt(document.getElementById("aantalSpelers").value);
      const naamvelden = document.getElementById("naamvelden");
      naamvelden.innerHTML = "";
      for (let i = 0; i < n; i++) {
        naamvelden.innerHTML += `<input type="text" id="speler_${i}" placeholder="Naam speler ${i + 1}"/><br>`;
      }
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      const aantalSpelers = parseInt(document.getElementById("aantalSpelers").value);
      const aantalRondes = parseInt(document.getElementById("aantalRondes").value);
      const aantalVelden = parseInt(document.getElementById("aantalVelden").value);

      veldInstellingen = [];
      for (let i = 0; i < aantalVelden; i++) {
        veldInstellingen.push(parseInt(document.getElementById(`veld_${i}`).value));
      }

      const benodigdeSpelersPerRonde = veldInstellingen.reduce((acc, val) => acc + val * 2, 0);
      if (benodigdeSpelersPerRonde > aantalSpelers) {
        alert(`Je hebt ${aantalSpelers} spelers, maar er zijn ${benodigdeSpelersPerRonde} nodig per ronde.`);
        return;
      }

      spelers = [];
      for (let i = 0; i < aantalSpelers; i++) {
        const naam = document.getElementById(`speler_${i}`).value.trim();
        spelers.push(naam || `Speler ${i + 1}`);
        punten[spelers[i]] = 0;
      }

      schema = genereerSchema(spelers, aantalRondes, veldInstellingen);
      renderSchema();
    });

    function genereerSchema(spelers, rondes, veldInstellingen) {
      const schema = [];
      for (let r = 0; r < rondes; r++) {
        const ronde = [];
        const mix = [...spelers].sort(() => Math.random() - 0.5);
        let index = 0;
        for (let v = 0; v < veldInstellingen.length; v++) {
          const teamSize = veldInstellingen[v] * 2;
          if (index + teamSize <= mix.length) {
            const match = mix.slice(index, index + teamSize);
            ronde.push({ veld: v + 1, teamA: match.slice(0, veldInstellingen[v]), teamB: match.slice(veldInstellingen[v]) });
            index += teamSize;
          }
        }
        schema.push(ronde);
      }
      return schema;
    }

    function renderSchema() {
      appDiv.innerHTML = '<button id="resetScores">Reset uitslagen</button> <button id="resetAll">Opnieuw beginnen</button>';
      schema.forEach((ronde, i) => {
        const div = document.createElement("div");
        div.className = "blok";
        div.innerHTML = `<h2>Ronde ${i + 1}</h2>`;
        ronde.forEach((wedstrijd, j) => {
          const id = `r${i}_v${j}`;
          div.innerHTML += `
            <div class="veld">
              <strong>Veld ${wedstrijd.veld}</strong><br>
              ${wedstrijd.teamA.join(" & ")} <input type="number" min="0" id="${id}a"> -
              <input type="number" min="0" id="${id}b"> ${wedstrijd.teamB.join(" & ")}<br>
            </div>`;
        });
        appDiv.appendChild(div);
      });
      appDiv.innerHTML += "<h2>Stand</h2><table border='1' id='standTabel'><tr><th>Speler</th><th>Punten</th></tr></table>";
      document.getElementById("resetScores").addEventListener("click", resetScores);
      document.getElementById("resetAll").addEventListener("click", () => location.reload());
      setupFirebaseSync();
    }

    function updateStand() {
      spelers.forEach(sp => punten[sp] = 0);
      schema.forEach((ronde, i) => {
        ronde.forEach((wedstrijd, j) => {
          const id = `r${i}_v${j}`;
          const elA = document.getElementById(`${id}a`);
          const elB = document.getElementById(`${id}b`);
          const a = parseInt(elA?.value);
          const b = parseInt(elB?.value);
          if (!isNaN(a) && !isNaN(b)) {
            let pa = 0, pb = 0;
            if (a > b) pa = 3;
            else if (a < b) pb = 3;
            else pa = pb = 1;
            wedstrijd.teamA.forEach(sp => punten[sp] += pa);
            wedstrijd.teamB.forEach(sp => punten[sp] += pb);
          }
        });
      });
      const table = document.getElementById("standTabel");
      table.innerHTML = "<tr><th>Speler</th><th>Punten</th></tr>";
      Object.entries(punten)
        .sort((a, b) => b[1] - a[1])
        .forEach(([naam, score]) => {
          table.innerHTML += `<tr><td>${naam}</td><td>${score}</td></tr>`;
        });
    }

    function setupFirebaseSync() {
      schema.forEach((ronde, i) => {
        ronde.forEach((wedstrijd, j) => {
          const id = `r${i}_v${j}`;
          const docRef = doc(db, `scores_${team}`, id);

          onSnapshot(docRef, (snap) => {
            if (snap.exists()) {
              const data = snap.data();
              document.getElementById(`${id}a`).value = data.a;
              document.getElementById(`${id}b`).value = data.b;
              updateStand();
            }
          });

          ["a", "b"].forEach(kant => {
            document.getElementById(`${id}${kant}`).addEventListener("change", () => {
              const aVal = parseInt(document.getElementById(`${id}a`).value);
              const bVal = parseInt(document.getElementById(`${id}b`).value);
              if (!isNaN(aVal) && !isNaN(bVal)) {
                const now = new Date().toISOString().split('T')[0]; const wedstrijd = schema[i][j]; setDoc(docRef, {   a: aVal,   b: bVal,   datum: now,   teamA: wedstrijd.teamA,   teamB: wedstrijd.teamB });
              }
              updateStand();
            });
          });
        });
      });
    }

    async function resetScores() {
      for (let i = 0; i < schema.length; i++) {
        for (let j = 0; j < schema[i].length; j++) {
          const id = `r${i}_v${j}`;
          const docRef = doc(db, `scores_${team}`, id);
          await deleteDoc(docRef);
          document.getElementById(`${id}a`).value = "";
          document.getElementById(`${id}b`).value = "";
        }
      }
      updateStand();
    }
  </script>
  <style>
    body { font-family: 'Open Sans', sans-serif; padding: 1rem; }
    .instellingen input { margin: 4px 0; }
    .blok { margin-top: 2rem; }
    .veld { margin: 1rem 0; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; }
    table { border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 6px 10px; }
    .logo {
  position: absolute;
  top: 10px;
  left: 10px;
  height: 40px;
  z-index: 100;
}
  </style>
</head>
<body>
  <img src="logo.png" alt="ASV33 Logo" class="logo">

  <div id="teamSelect">
    <h2>Kies je team</h2>
    <select id="teamKeuze">
      <option value="">-- Kies een team --</option>
      <option value="JO11">JO11</option>
      <option value="JO12">JO12</option>
      <option value="JO13">JO13</option>
      <option value="JO14">JO14</option>
    </select>
    <br><br>
    <button id="teamSelectBtn">Start</button>
  </div>

  <div id="configuratie" style="display:none">
    <h1>Toernooitje Planner</h1>
    <div class="instellingen">
      <label>Aantal spelers: <input type="number" id="aantalSpelers" min="4" max="30" value="10"></label><br>
      <div id="naamvelden"></div>
      <label>Aantal rondes: <input type="number" id="aantalRondes" value="5"></label><br>
      <label>Aantal velden: <input type="number" id="aantalVelden" value="2"></label><br>
      <div id="veldenInstellingen"></div>
      <button id="startBtn">Genereer schema</button>
    </div>
    <div id="oudeToernooiSelectie"></div>
    <div id="app"></div>
  </div>
</body>
</html>
